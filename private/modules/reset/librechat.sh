#!/bin/sh

if [ "$(id -u)" = "0" ]; then
	echo "You should not be root"
	exit 0
fi

echo "#Reset librechat##################"
CLOUDNAME=$(jq -r ".info.name" /disk/admin/modules/_config_/_cloud_.json)
EMAIL="admin@${CLOUDNAME}.mydongle.cloud"
MEILISEARCH_KEY=$(jq -r ".key" /disk/admin/modules/_config_/meilisearch.json)
cd /disk/admin/modules
systemctl stop librechat.service

MONGODB_PASSWORD=$(jq -r ".password" /disk/admin/modules/_config_/mongodb.json)
DBPASS=$(pwgen -B -c -y -n -r "\"\!\'\`\$@~#%^&*()+={[}]|:;<>?/" 12 1)
mongosh --host 127.0.0.1 -u admin --authenticationDatabase admin -p $MONGODB_PASSWORD <<EOF
use librechatDB
db.dropDatabase()
db.dropUser("librechatUser")
db.createUser({
	user: "librechatUser",
	pwd: "$DBPASS",
	roles: [
		{ role: "readWrite", db: "librechatDB" },
		{ role: "dbAdmin", db: "librechatDB" }
	]
});
EOF

PASSWD=$(pwgen -B -c -y -n -r "\"\!\'\`\$@~#%^&*()+={[}]|:;<>?/" 12 1)

rm -rf /disk/admin/modules/librechat
mkdir -p /disk/admin/modules/librechat/logs
cp /usr/local/modules/librechat/.env.example /disk/admin/modules/librechat/.env
cp /usr/local/modules/librechat/librechat.example.yaml /disk/admin/modules/librechat/librechat.yaml
sed -i -e "s|^MEILI_HOST=.*|MEILI_HOST=http://127.0.0.1:7700|" /disk/admin/modules/librechat/.env
sed -i -e "s|^MEILI_MASTER_KEY=.*|MEILI_MASTER_KEY=$MEILISEARCH_KEY|" /disk/admin/modules/librechat/.env
sed -i -e "s|^MONGO_URI=.*|MONGO_URI=mongodb://librechatUser:$DBPASS@127.0.0.1:27017/librechatDB|" /disk/admin/modules/librechat/.env
chown admin:admin /disk/admin/modules/librechat

cd /usr/local/modules/librechat
NODE_DEBUG=mongoose npm run create-user -- ${EMAIL} ${CLOUDNAME} ${CLOUDNAME} ${PASSWD} --email-verified=false > /dev/null
echo "{\"email\":\"${EMAIL}\", \"username\":\"${CLOUDNAME}\", \"password\":\"${PASSWD}\"}" > /disk/admin/modules/_config_/librechat.json

systemctl start librechat.service
systemctl enable librechat.service

echo "{ \"a\":\"status\", \"module\":\"$(basename \""$0"\" .sh)\", \"state\":\"finish\" }" | websocat -1 ws://localhost:8094
