<table>
<tr><td><button onclick="appButton(103);" style="font-size:larger;">Up</button></td><td align="right"><button onclick="appButton(108);" style="font-size:larger;">Down</button></td></tr>
<tr><td colspan="2"><canvas id="canvas" width=128 height=128 style="width:300px; height:300px; margin:15px 0px;"></canvas></td></tr>
<tr><td><button onclick="appButton(105);" style="font-size:larger;">Left</button></td><td align="right"><button onclick="appButton(106);" style="font-size:larger;">Right</button></td></tr>
</table>
<script>
var initDone = false;
var Module;
var socket;

function loadScript(src) {
	return new Promise((resolve, reject) => {
		const script = document.createElement("script");
		script.type = "text/javascript";
		script.src = src;
		script.onload = () => resolve(script);
		script.onerror = (error) => reject(error);
		document.body.appendChild(script);
	});
}

async function appInit(log) {
	if (!initDone) {
		await loadScript("app.js");
		initDone = true;
	}
	Module = {
		print: function(text) { if (log) console.log(text); },
		canvas: document.getElementById("canvas"),
		arguments: ["-s"]
	};
	await appCreate(Module);
}

function appButton(b) {
	Module._button(b);
}

function appServerWriteDataHtml(data, isB64) {
	var st;
	if (isB64)
		st = atob(data);
	else
		st = data;
	//console.log("(JS) appServerWriteDataHtml: #" + st + "#B64:" + isB64);
	socket.send(st);
}

function appServerReceiveHtml(data, doB64) {
	var st;
	if (doB64)
		st = btoa(data);
	else
		st = data;
	var size = Module.lengthBytesUTF8(st) + 1;
	var ptr = Module._malloc(size);
	Module.stringToUTF8(st, ptr, size);
	Module._serverReceiveHtml(ptr, doB64);
	Module._free(ptr);
}

function connectWebSocket(url) {
	const ws = "ws://" + url + ":8094";
	console.log("socketInit " + ws);
	socket = new WebSocket(ws);
	socket.binaryType = "arraybuffer";
	socket.onopen = () => {
		console.log("socket onopen");
	}
	socket.onerror = (e) => {
		console.log("socket onerror " + JSON.stringify(e));
	}
	socket.onclose = (e) => {
		console.log("socket onclose " + JSON.stringify(e));
	}
	socket.onmessage = (msg) => {
		appServerReceiveHtml(msg.data, 1);
	}
}
</script>
<script>
appInit(1);
connectWebSocket("127.0.0.1");
</script>
