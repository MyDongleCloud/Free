<table>
<tr><td><button onclick="appButton(103);" style="font-size:larger;">Up</button></td><td align="right"><button onclick="appButton(108);" style="font-size:larger;">Down</button></td></tr>
<tr><td colspan="2"><canvas id="canvas" width=128 height=128 style="width:512px; height:512px; margin:15px 0px;"></canvas></td></tr>
<tr><td><button onclick="appButton(105);" style="font-size:larger;">Left</button></td><td align="right"><button onclick="appButton(106);" style="font-size:larger;">Right</button></td></tr>
</table>
<script>
var Module;
var socket;

function appInit(log) {
	Module = {
		print: function(text) { if (log) console.log(text); },
		canvas: (function() { return document.getElementById("canvas"); })(),
		arguments: ["-s"]
	};

	const script = document.createElement("script");
	script.type = "text/javascript";
	script.src = "app.js";
	document.body.appendChild(script);
}

function appButton(b) {
	Module._button(b);
}

function appServerWriteDataHtml(data, isB64) {
	var st;
	if (isB64)
		st = atob(data);
	else
		st = data;
	//console.log("(JS) appServerWriteDataHtml: #" + st + "#B64:" + isB64);
	socket.send(st);
}

function appServerReceiveHtml(data, doB64) {
	var st;
	if (doB64)
		st = btoa(data);
	else
		st = data;
	var size = lengthBytesUTF8(st) + 1;
	var ptr = Module._malloc(size);
	stringToUTF8(st, ptr, size);
	Module._serverReceiveHtml(ptr, doB64);
	Module._free(ptr);
}

function connectWebSocket(url) {
	const ws = "ws://" + url + ":8094";
	console.log("socketInit " + ws);
	socket = new WebSocket(ws);
	socket.binaryType = "arraybuffer";
	socket.onopen = () => {
		console.log("socket onopen");
	}
	socket.onerror = (e) => {
		console.log("socket onerror " + JSON.stringify(e));
	}
	socket.onclose = (e) => {
		console.log("socket onclose " + JSON.stringify(e));
	}
	socket.onmessage = (msg) => {
		appServerReceiveHtml(msg.data, 1);
	}
}
</script>
<script>
appInit(1);
connectWebSocket("127.0.0.1");
</script>
