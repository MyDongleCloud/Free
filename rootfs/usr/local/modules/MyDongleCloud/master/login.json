<?php
function domainFromFqdn($fqdn) {
	$parts = explode('.', $fqdn);
	if (count($parts) <= 2)
		return $fqdn;
	if (is_numeric($parts[count($parts) - 1]))
		return $fqdn;
	$tmp = ($parts[count($parts) - 2] == "mydongle" || $parts[count($parts) - 2] == "myd") ? -3 : -2;
	return implode('.', array_slice($parts, $tmp));
}

function passwordCheck($password, $dHash): bool {
	$pieces = explode('$', $dHash);
	if (count($pieces) !== 4)
		return false;
	list($header, $iter, $salt, $hash) = $pieces;
	if (preg_match('#^pbkdf2_([a-z0-9A-Z]+)$#', $header, $m))
		$algo = $m[1];
	else
		return false;
	$calc = hash_pbkdf2($algo, $password, $salt, (int)$iter, 32, true);
	return hash_equals($calc, base64_decode($hash));
}

$path = "../../../../../disk/admin/.modules/MyDongleCloud/users.json";
$h = fopen($path, "r");
$users = json_decode(fread($h, filesize($path)), true);
fclose($h);
$ret = false;
$reason = "";
$user = "";
if (isset($_POST["user"]))
	$user = $_POST["user"];
else if ($useCookie === true && isset($_COOKIE["user"]))
	$user = $_COOKIE["user"];
else
	foreach ($users as $key => $val)
		if ($val["email"] == $_POST["email"]) {
			$user = $key;
			break;
		}
if ($user != "" && isset($users[$user])) {
	if (isset($users[$user]["token"]) && isset($_POST["token"]))
		$ret = $users[$user]["token"] == $_POST["token"];
	else if (isset($users[$user]["token"]) && $useCookie === true && isset($_COOKIE["token"]))
		$ret = $users[$user]["token"] == $_COOKIE["token"];
	else if (isset($users[$user]["password"]))
		$ret = $_POST["password"] == $users[$user]["password"];//passwordCheck($_POST["password"], $users[$user]["password"]);
	else {
		$url = (str_starts_with($_SERVER["HTTP_REFERER"], "https") ? "https://" : "http://") . $_SERVER["HTTP_HOST"];
		$protectedUrl = $url . "/MyDongleCloud/protected/empty.html";
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_URL, $protectedUrl);
		curl_setopt($ch, CURLOPT_USERPWD, $user . ":" . $_POST["password"]);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		$response = curl_exec($ch);
		$http_status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
		$ret = $http_status === 200;
		$curl_error = curl_error($ch);
		curl_close($ch);
	}
	if ($ret && (isset($_GET["set"]) || isset($_POST["set"]))) {
		$token = bin2hex(random_bytes(16));
		$users[$user]["token"] = $token;
		$users[$user]["tokenExpiration"] = 0;
		$h = fopen($path, "w");
		fwrite($h, json_encode($users));
		fclose($h);
		$expiration_time = time() + (86400 * 30);
		$path = "/";
		$tmp = preg_replace("/^([^:]*)(?::\\d+)?$/i" , "$1", $_SERVER["HTTP_HOST"]);
		$domain = domainFromFqdn($tmp);
		setcookie("user", $user, $expiration_time, $path, $domain);
		setcookie("token", $token, $expiration_time, $path, $domain);
	}
}
if ($ret && $noReturnOnSuccess === true)
		;
else {
	$a = ["error" => $ret ? 0 : 1, "reason" => $reason];
	if (isset($token))
		$a["token"] = $token;
	echo json_encode($a);
	exit();
}
?>
