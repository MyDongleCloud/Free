<?php
use PHPMailer\PHPMailer\PHPMailer;

function domainFromFqdn($fqdn) {
	$parts = explode('.', $fqdn);
	if (count($parts) <= 2)
		return $fqdn;
	if (is_numeric($parts[count($parts) - 1]))
		return $fqdn;
	$tmp = ($parts[count($parts) - 2] == "mydongle" || $parts[count($parts) - 2] == "myd") ? -3 : -2;
	return implode('.', array_slice($parts, $tmp));
}

function passwordMakeHash($password) {
	$iter = 36000;
	$salt = base64_encode(random_bytes(64));
	$salt = substr($salt, 0, 12);
	$calc = hash_pbkdf2("sha256", $password, $salt, $iter, 32, true);
	return "pbkdf2_sha256\${$iter}\${$salt}\$" . base64_encode($calc);
}

function passwordCheck($password, $dHash): bool {
	$pieces = explode('$', $dHash);
	if (count($pieces) !== 4)
		return false;
	list($header, $iter, $salt, $hash) = $pieces;
	if (preg_match('#^pbkdf2_([a-z0-9A-Z]+)$#', $header, $m))
		$algo = $m[1];
	else
		return false;
	$calc = hash_pbkdf2($algo, $password, $salt, (int)$iter, 32, true);
	return hash_equals($calc, base64_decode($hash));
}

$dir = "../../../../../disk/admin/.modules/MyDongleCloud/";
$h = fopen($dir . "space.json", "r");
$space = json_decode(fread($h, filesize($dir . "space.json")), true);
fclose($h);
$h = fopen($dir . "users.json", "r");
$users = json_decode(fread($h, filesize($dir . "users.json")), true);
fclose($h);
$ret = false;
$doSet = false;
$user = "";
$token = "";
if (isset($_POST["user"]))
	$user = $_POST["user"];
foreach ($users as $key => $val)
	if (isset($_POST["email"]) && $val["email"] == $_POST["email"]) {
		$user = $key;
		break;
	}
if ($user == "" && isset($_COOKIE["user"]))
	$user = $_COOKIE["user"];
if (isset($_POST["token"]))
	$token = $_POST["token"];
if ($token == "" && isset($_COOKIE["token"]))
	$token = $_COOKIE["token"];
if ($user != "" && isset($users[$user])) {
	if (isset($_POST["reset"])) {
		$resetCode = rand(100001, 999999);
		if ($user == "admin") {
			$ret = false;
			$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
			if ($socket !== false) {
				if (socket_connect($socket, "127.0.0.1", 8093)) {
					$st = json_encode(array("a" => "passcode", "v" => $resetCode));
					$ret = socket_send($socket, $st, strlen($st), 0) !== false;
				}
				socket_close($socket);
			}
		}
		if (file_exists(dirname(__FILE__) . "/vendor/autoload.php")) {
			$email = $_POST["email"];
			$content = <<<EOT
Hello,

You have asked to reset the password of the MyDongle.Cloud account of {$email}.

The reset code is: {$resetCode}

Please reset your password using the app.

Best regards,

The MyDongle.Cloud team
EOT;
			require_once(dirname(__FILE__) . "/vendor/autoload.php");
			$mail = new PHPMailer();
			$mail->IsSMTP();
			$mail->SMTPDebug = 0;
			$mail->Host = "localhost";
			$mail->Port = 465;
			$mail->SetFrom("admin@" . $space["name"] . "mydongle.cloud", "MyDongle.Cloud");
			$mail->Subject = "MyDongle.Cloud: Reset your password";
			$mail->Body = $content;
			$mail->IsHTML(false);
			$mail->AddAddress($email);
			//$mail->Send();
		}
		if ($ret) {
			$users[$user]["resetCode"] = $resetCode;
			$users[$user]["resetCodeTries"] = 3;
			$users[$user]["resetCodeExpiration"] = time() + 90;
			$h = fopen($dir . "users.json", "w");
			fwrite($h, json_encode($users));
			fclose($h);
		}
		echo json_encode(array("error" => $ret ? 0 : 1, "reason" => "reset"));
		exit;
	} else if (isset($_POST["resetCode"])) {
		$ret = $users[$user]["resetCode"] == $_POST["resetCode"] && $users[$user]["resetCodeTries"] > 0 && $users[$user]["resetCodeExpiration"] > time();
		if ($ret) {
			unset($users[$user]["resetCode"]);
			unset($users[$user]["resetCodeTries"]);
			unset($users[$user]["resetCodeExpiration"]);
			$users[$user]["password"] = passwordMakeHash($_POST["password"]);
			if (file_exists(dirname(__FILE__) . "/vendor/autoload.php")) {
				$email = $_POST["email"];
				$content = <<<EOT
Hello,

The password of the MyDongle.Cloud account of {$email} has been changed.

Best regards,

The MyDongle.Cloud team
EOT;
				require_once(dirname(__FILE__) . "/vendor/autoload.php");
				$mail = new PHPMailer();
				$mail->IsSMTP();
				$mail->SMTPDebug = 0;
				$mail->Host = "localhost";
				$mail->Port = 465;
				$mail->SetFrom("admin@" . $space["name"] . "mydongle.cloud", "MyDongle.Cloud");
				$mail->Subject = "MyDongle.Cloud: Reset your password";
				$mail->Body = $content;
				$mail->IsHTML(false);
				$mail->AddAddress($email);
				//$mail->Send();
			}
		} else
			$users[$user]["resetCodeTries"]--;
		$h = fopen($dir . "users.json", "w");
		fwrite($h, json_encode($users));
		fclose($h);
		$doSet = true;
	} else if (isset($users[$user]["token"]) && $token != "")
		$ret = $users[$user]["token"] == $token;
	else if (isset($users[$user]["password"])) {
		$ret = passwordCheck($_POST["password"], $users[$user]["password"]);
		$doSet = true;
	} else {
		$url = (str_starts_with($_SERVER["HTTP_REFERER"], "https") ? "https://" : "http://") . $_SERVER["HTTP_HOST"];
		$protectedUrl = $url . "/MyDongleCloud/protected/empty.html";
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_URL, $protectedUrl);
		curl_setopt($ch, CURLOPT_USERPWD, $user . ":" . $_POST["password"]);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		$response = curl_exec($ch);
		$http_status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
		$ret = $http_status === 200;
		$curl_error = curl_error($ch);
		curl_close($ch);
		$doSet = true;
	}
}
if ($ret && isset($noReturnOnSuccess) && $noReturnOnSuccess == true)
	;
else {
	$data = array("error" => $ret ? 0 : 1, "reason" => "authentication");
	if ($ret) {
		if ($doSet) {
			$token = bin2hex(random_bytes(16));
			$users[$user]["token"] = $token;
			$users[$user]["tokenExpiration"] = 0;
			$h = fopen($dir . "users.json", "w");
			fwrite($h, json_encode($users));
			fclose($h);
			$expiration_time = time() + (86400 * 30);
			$tmp = preg_replace("/^([^:]*)(?::\\d+)?$/i" , "$1", $_SERVER["HTTP_HOST"]);
			$domain = domainFromFqdn($tmp);
			setcookie("user", $user, $expiration_time, "/", $domain);
			setcookie("token", $token, $expiration_time, "/", $domain);
			$data["user"] = $user;
			$data["token"] = $token;
		}
		$data["space"] = $space;
	}
	echo json_encode($data);
	exit;
}
?>
