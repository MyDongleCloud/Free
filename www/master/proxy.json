<?php
if (php_sapi_name() != "apache2handler" || $_SERVER["REQUEST_METHOD"] != "POST")
	exit;
$PATH = "/etc/haproxy/haproxy.conf";
$json = file_get_contents('php://input');
$data = json_decode($json, true);
$n = $data["serviceName"] . "-" . $data["spaceName"];
$format = <<<EOT
frontend %s
	bind 209.188.18.155:%d
	mode tcp
	tcp-request inspect-delay 5s
	tcp-request content accept if { req_ssl_hello_type 1 }
	use_backend %s-backend if { req_ssl_sni -i mail.%s.mydongle.cloud }
backend %s-backend
	mode tcp
	server %s-frps 127.0.0.1:%d no-check

EOT;
$line = sprintf($format, $n, $data["localPort"] $n, $data["spaceName"], $n, $n, $data["remotePort"]);
if ($data["action"] == "set") {
	$handle = fopen($PATH, "a");
	fwrite($handle, $line);
	fclose($handle);
	echo "{ \"ret\": \"success\" }";
} else if ($data["action"] == "remove") {
    $lines = file($PATH);
    $lines2 = [];
    foreach ($lines as $line_)
        $lines2[] = $line_;
    file_put_contents($PATH, implode("", $lines2));
	echo "{ \"ret\": \"success\" }";
} else
	echo "{ \"ret\": \"error\" }";
system("sudo /etc/init.d/haproxy restart 2>&1 > /dev/null");
?>
