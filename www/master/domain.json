<?php
if (php_sapi_name() != "apache2handler" || $_SERVER["REQUEST_METHOD"] != "POST")
	exit;
$PATH = "/etc/bind/mydongle.cloud";
$json = file_get_contents('php://input');
$data = json_decode($json, true);
$line = "_acme-challenge." . $data["space"] . "    300    IN      TXT     " . $data["text"] . "\n";
if ($data["action"] == "set") {
	$handle = fopen($PATH, "a");
	fwrite($handle, $line);
	fclose($handle);
	echo "{ \"ret\": \"success\" }";
} else if ($data["action"] == "remove") {
    $lines = file($PATH);
    $lines2 = [];
    foreach ($lines as $line_)
        if ($line_ !== $line)
            $lines2[] = $line_;
    file_put_contents($PATH, implode("", $lines2));
	echo "{ \"ret\": \"success\" }";
} else
	echo "{ \"ret\": \"error\" }";
system("sudo /etc/init.d/named restart 2>&1 > /dev/null");
?>
